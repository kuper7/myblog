# p.563算法原理解析

## 1.概览

​		下图展示了，人工主观语音评估mos-lqs，双端和单端客观语音评估mos-lqo这三种方法的差异。

<center><img src="https://pangcong1117.github.io/myblog/images/语音评估模式图.png"/>


​		p563算法可以被想象成一个专家使用测试设备如传统的听筒侦听一个真实的电话。这个形象的表达解释了算法主要的应用并且允许使用者去对P563算法获得的分数进行评分。P563算法给出的质量分通过在测量点连接一个常规的听筒基于感知质量预测。

​		因此，侦听设备是p563算法的一部分，信号首先会被预处理。整个预处理过程由话音接收端模型开始。之后是通过语音活动检测算法（VAD）信号中包含话音的部分并计算话音电平。最终话音电平被调整到-26dbov（3300以下）。预处理过的语音数据将分别进行几项独立分析研究，像一层多个传感器，检测一组表征信号的参数。之后基于一组关键参数，开始分析主要的失真类型。

​		关键参数和分析出的主要失真类别等用于调整语音质量模型。尽管多个不同失真发生在同一个信号中，但某些失真要比其他失真作用更显著，这提供了一个基于感知的加权。P563的基础方框图下图给出:



<center>
    <img src="https://pangcong1117.github.io/myblog/images/P563算法方框图.png"/>

​	

​		P563算法的信号参数化可以被分为以下三个独立的函数部分，这与失真的主要类别相对应：

- **Vocal tract analysis and unnaturalness of speech声道分析和话音不自然度分析（音色音调及自然度角度）**
- **Analysis of strong additional noise强附加噪声的分析（噪声分析角度，分析与信噪比有关）**
- **Interruptions, mutes and time clipping语音间断，减弱，裁剪分析（语音元素完整角度）**

​		最终为了证明最终语音客观质量评分结果与语音质量主观评分mos-lqs关联，引入相关系数这一数学指标。P563和主观评分的关联程度可以用相关系数描述：
$$
r=\frac{\sum (x_{i}-\bar{x})(y_{i}-\bar{y})}{\sqrt{(x_{i}-\bar{x})^2(y_{i}-\bar{y})^2}}
$$
​		式子中，x~i~是第i种情景下主观mos得分，y~i~是对应情况下P.563算法计算出的客观质量评分，$\bar{x}$，$\bar{y}$是所有情况下的均值。

​		在已知24组遵循ITU基准的测试实验中，相关系数平均值为0.88。

## 2.详细算法原理

### 2.1语音前端相关描述符及预处理算法

#### 2.1.1  Voice activity detection端点检测

​		VAD算法基于一个自适应能量阈值，逐帧检测音频能量，超过阈值则为活跃语音信号，否则为无声段（背景噪声段），详细框图如下：

<center>
    <img src="https://pangcong1117.github.io/myblog/images/VAD算法框图.png"/>



​		自适应能量阈值th~est~首先设定为全局均值，之后自适应逼近环境噪声值，公式如下：
$$
\left\{\begin{array}{l}
m_{x}=\sum_{i=0}^{n-1}{\frac{x_{noise}(i)}{n}}       \\
\ th_{est}=m_{x}+2*\sqrt{\sum_{i=0}^{n-1}\frac{(x_{noise}(i)-m_{x})^2}{n}}
\end{array}\right.
$$
​		还有两点额外判定：

- 如果仅12ms及以下长度的语音能量超过阈值，标记为无声段
- 活跃语音段之间的间隔小于200ms的，连接在一起

#### 2.1.2  IRS filtering中间系统滤波

​		测试的信号经过中间系统的传递后，对某些参数会造成影响。基于此，在预处理阶段需要进行一下两项步骤：

1. 对250hz到3000hz的信号进行电平估测并归一化到-26dBov处
2. 在第二步中，使用FFT滤波器对整文件在频域应用滤波器。滤波器特性与ITU-T Rec. P.830中给出的中间参考系统接收特性相似

​		滤波后的信号即可应用于语音音量衰减、非人声、帧重复、非自然哔哔声、基本音质、非自然安静、局部背景噪声和全局背景噪声的测试中。

#### 2.1.3  Signal normalization and level calculation信号归一化及电平计算

​		为了归一化到-26 dBov，算法基于VAD的输出计算每个活动帧的均方根值来估计语音水平。信号电平被归一化后，使用四阶巴特沃思高通滤波器滤波，截止频率100hz。

​		除了计算语音静默的参数要求原始信号以外，所有不使用IRS滤波信号的参数都使用这个归一化信号。

#### 2.1.4  SpeechSectionsLevelVar描述符

​		SpeechSectionsLevelVar是一个描述句子之间层次变化的描述符，它计算信号中每个语音部分的电平以及最大值和最小值之间的差值。

#### 2.1.5  LocalLevelVar描述符

​		LocalLevelVar描述信号的能量变化。均方根值是逐帧计算的。然后计算均方根数组的一阶导数，计算功率均值。

#### 2.1.6Pitch synchronous extraction基音同步分析提取（很重要）

​		基音周期和基音频率数据在后续的P563算法中是需要的，基音周期及频率数据提取框图如下：



<center>
    <img src="https://pangcong1117.github.io/myblog/images/基音周期及频率数据提取框图.png"/>

​    



##### 2.1.6.1  Pitch period estimate and voice/unvoiced decision基音周期估计及浊音/清音判决

 		人在发音时，根据声带是否震动可以将语音信号分为清音跟浊音两种。**浊音又称有声语言，携带着语言中大部分的能量，浊音在时域上呈现出明显的周期性；而清音类似于白噪声，没有明显的周期性。**发浊音时，气流通过声门使声带产生张弛震荡式振动，产生准周期的激励脉冲串。**这种声带振动的频率称为基音频率，相应的周期就成为基音周期。**

​		基音周期估计是通过自相关方法实现的，自相关计算中每一帧64ms（512个点），帧重叠面积50%。信号首先进行汉宁窗加窗处理:
$$
y_{i}=0.5x_{i}[1-cos(w)]\quad for\ i=0..(n-1)
$$
​		其中:
$$
w=\frac{2\pi i}{n}\\
$$
​		x为输入信号，n为帧长度
$$
R_{y}(\tau)=y(\tau)\otimes y^{*}(-\tau)=fft^{-1}(fft(w)\times fft(w)^{*})
$$


自相函数表示一个信号和延迟$\tau$点后该信号本身的相似性。如果信号x(n)具有周期性，那么它的自相关函数也具有周期性，而且周期与信号x(n)的周期性相同。自相关函数提供了一种获取周期信号周期的方法。在周期信号周期的整数倍上，它的自相关函数可以达到最大值，因此可以不考虑起始时间，而从自相关函数的第一个最大值的位置估计出信号的基音周期，这使自相关函数成为信号基音周期估计的一种工具。

​		$R_{y}(\tau)$基于最大值$R_{y}(0)$归一化，使用幅值一半的汉宁窗过滤输出数组的32个之后的元素。滤波后的自相关系数N~i~由下式给出：

$$
N_{i}=\frac{R_i}{R_0}\ for\ i=0,1,2,...31\ andN_{i}=\frac{R_i}{2R_0}[1-cos(w)]\ for\ i=32,33,...,n-1
$$
​		其中
$$
w=\frac{2\pi i}{64}
$$
​		然后在第20个和第100个元素之间搜索最大值，其基音频率范围从80Hz(T=100\*0.125=12.5ms)到400Hz(T=20\*0.125=2.5ms)，（这是我的理解，与手册有些许出入）。如果这个最大值大于0.5，那么这帧被归类为浊音，保存候选基音周期最大值(Tmax)。

​		我们得到了每个浊音帧的基音周期，为了避免基音加倍（意思是我们找到的是谐音而不是基音），我们维护的候选基音周期最大值（$T_{max}$）需要与上一帧被判为浊音的基音周期$T_{old}$($T_{old}$相当于一个局部峰值）进行比较。

​		若满足如下公式：
$$
N_{T_{old}}>\frac{1+N_{T_{max}}}{3}
$$
​		则我们判定误拾谐音，之前找到的只是局部峰值，更新候选基音周期最大值$T_{max}$，而被$T_{old}$设置为当前帧的基音周期。



- ​		**图解基音周期提取原理**

​		为了更清晰的讲解基音周期的检测的原理，借用一张图片来说明，下图是某帧语音的自相关函数图，采样率16k：

<center><img src="https://pangcong1117.github.io/myblog/images/某帧的自相关函数图片.jpg"/>



​		该帧的自相关函数中，除去第一个最大值后（0处），最大值Kmax= 114，那么该帧对应的基频16kHz/114=140Hz。由于P563算法使用的采样率为8khz，所以与本图计算基频周期有较小的差别。更多语音基音检测的细节可参考这篇文章，可以加深对语音基频的理解，通俗易懂，博客链接https://blog.csdn.net/zouxy09/article/details/9141875。



##### 2.1.6.2  Pitch mark placement基音标注

​		精确地确定语音最大幅度的位置是语音信号基音同步分析的一个重要部分，基音周期被精确地估计出来之后，还需要进行基音标注，准确地标注基音脉冲的最大位置。

​		P563算法使用的方法是**加窗语音信号$x$与脉冲序列的互相关$y$（卷积）**来寻找基音标注位置。对基音标注的算法，标注的位置一般都是在基音脉冲的短时能量的尖峰时刻上，P563算法逐帧执行以找到最佳的基音标注位置。

​		互相关公式为：
$$
R_{xy}(\tau)=x(\tau)\otimes y(\tau)
$$

$$
x_{i}=0.5z_{i}[1-cos(w)]\quad for\ i=0...n
$$



​		其中$w=\frac{2\pi i}{n}$，z为输入语音原始信号，n为帧长，$\begin{cases}
y_{i}=1 & \text{if }i为基音周期l的倍数 \\ 
y_{i}=0  & \text{if } i为其他
\end{cases}$,$\tau$是偏移量，$l$是基音周期。

​		当上述算法计算结束，**$i_{max}$被标记为最大的$R_{xy}$的下标，基音就标记在这一帧偏差量为$i_{max}$的位置**。





##### 2.1.6.3	Resolution of inconsistencies  解决基音标注的不一致性

​		由于使用互相关的方法进行基音位置标注过程中时间对齐的误差，帧重叠的做法导致可能出现近距离上多个基音标记。如果两个基音标记之间的间隔小于10个点（1.25ms），则认为它们是由同一个基音派生而来的，相邻的基音间隔也被分析，那些长度超过给定阈值的基音间隔被标记为不一致。P563设计了一个局部调整的算法用于修改基音标记到最佳位置，并对基音标注不一致性进行记录。

​		在每个被判决为浊音的区段中，检测出**持续时间最长的基音**，这种稳定的基音会延伸到余下的部分。算法将基于此**加强一些基音标记位置，完全删除一些，并纠正其他位置**，基频一致性检测流程图如下图所示。

​		**算法具体流程为：在各浊音区段的一致性基音（持续时间最长最稳定的基音）检测到之后，启动之后的基音标记鉴别（流程图F2处）。在各浊音段本地检查，尝试将各段的音高标记更合理地放置在输入音频波形中并符合一致性阈值（流程图G2处）。如果不符合一致性检测，则删除当前不合理的基音标记，算法向后移动（流程图F3处），一区段一区段的进行检查。通过这种方式，实现所有浊音段的基音标记遵循一致性。**

<center><img src="https://pangcong1117.github.io/myblog/images/pitch-inconsistency handling.png"/>



##### 2.1.6.4  Boundary review浊音区段边界检查

​		由于处理的语音是**以帧为框架来划分**的，浊音区段有看似合理的基音标记，在边界处可能是不对的。**边界处的基音检测误差大大增加，甚至无法检测**。P563针对这个问题，采用了边界检查算法。下图为浊音段边界基音检查流程图（Voiced segment boundary pitch review），展示了用于评估和纠正浊音部分边界标记的算法。



<center><img src="https://pangcong1117.github.io/myblog/images/Voiced segment boundary pitch review.png"/>



​		在区段边界处，不断尝试可超过原定边界放置候选的更长基音周期（**try 周期更大，频率更小基音记为pitch-cycle**）进行评估(图6,C1)。将这个新定义的pitch-cycle与三个阈值进行比较(图6,D1, E2, F3)。**如果没通过任意一个测试，它将被pass掉，这个最后已知（成功通过三个阈值测试）的基音标记将被删除(图6,G1)**。这个基音标记被移除的位置被存储起来，用于后续的稳定性评估(图6,G2)。

​		在下一轮迭代中，对旧段边界内的基音标记进行详细检查。如果新定义的基音周期满足所有定义的阈值范围，则认定它为有效，并添加基音标记(图6,G3)。通过这种方式，分段可以缩小和扩展。根据下面定义的规则，若都满足，则将分段连接在一起。而当接受新的音高标记时，将与之前删除的标记进行比较(图6,H3)。当发现他们匹配时，则该段分界是稳定的，不需要进一步扩展或缩小。

- Length of cycle > Pre-determined threshold (Figure 6, D1);
- RMS energy of cycle > Pre-determined threshold (Figure 6, E2);
- Frequency content of new and current frame comparable (Figure 6, F3).



### 2.2	Description of the functional block 'Vocal tract analysis and Unnatural Voice'声道分析与非自然语音分析模块描述

未完待续